<div class="create-course-container">
    <div class="course-header">
        <button mat-icon-button (click)="goBack()" class="back-button">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-content">
            <h1>Create New Course</h1>
            <p>Build your course step by step</p>
        </div>
    </div>

    <mat-stepper #stepper orientation="horizontal" linear>
        <!-- Step 1: Basic Information -->
        <mat-step [stepControl]="basicInfoForm" label="Basic Info">
            <form [formGroup]="basicInfoForm">
                <div class="step-content">
                    <h2>Course Basic Information</h2>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Course Title</mat-label>
                            <input matInput formControlName="title" placeholder="Enter course title">

                            <!-- Loading spinner for async validation -->
                            <mat-spinner *ngIf="isTitleChecking" matSuffix diameter="20">
                            </mat-spinner>

                            <!-- Success icon when title is valid and available -->
                            <mat-icon
                                *ngIf="!isTitleChecking && basicInfoForm.get('title')?.valid && basicInfoForm.get('title')?.value"
                                matSuffix class="success-icon">
                                check_circle
                            </mat-icon>

                            <!-- Error icon when title has errors -->
                            <mat-icon
                                *ngIf="!isTitleChecking && basicInfoForm.get('title')?.invalid && basicInfoForm.get('title')?.touched"
                                matSuffix class="error-icon">
                                error
                            </mat-icon>

                            <!-- Dynamic error messages -->
                            <mat-error
                                *ngIf="basicInfoForm.get('title')?.invalid && basicInfoForm.get('title')?.touched">
                                {{ getTitleErrorMessage() }}
                            </mat-error>

                            <!-- Hint for validation status -->
                            <mat-hint
                                *ngIf="!basicInfoForm.get('title')?.errors && basicInfoForm.get('title')?.value?.length >= 5">
                                {{ isTitleChecking ? 'Checking availability...' : 'Title looks good!' }}
                            </mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Course Description</mat-label>
                            <textarea matInput formControlName="description" rows="4"
                                placeholder="Describe what students will learn in this course"></textarea>
                            <mat-error *ngIf="basicInfoForm.get('description')?.hasError('required')">
                                Description is required
                            </mat-error>
                            <mat-error *ngIf="basicInfoForm.get('description')?.hasError('minlength')">
                                Description must be at least 20 characters long
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="form-row two-columns">
                        <mat-form-field appearance="outline">
                            <mat-label>Category</mat-label>
                            <mat-select formControlName="category">
                                <mat-option *ngFor="let category of categories" [value]="category">
                                    {{category}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="basicInfoForm.get('category')?.hasError('required')">
                                Please select a category
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Level</mat-label>
                            <mat-select formControlName="level">
                                <mat-option *ngFor="let level of levels" [value]="level">
                                    {{level}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="basicInfoForm.get('level')?.hasError('required')">
                                Please select a level
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <!-- Thumbnail Upload -->
                    <div class="form-row">
                        <div class="thumbnail-upload">
                            <h3>Course Thumbnail</h3>
                            <div class="upload-area" *ngIf="!thumbnailPreview">
                                <input type="file" #thumbnailInput (change)="onThumbnailSelected($event)"
                                    accept="image/*" style="display: none;">
                                <button mat-stroked-button (click)="thumbnailInput.click()" type="button">
                                    <mat-icon>cloud_upload</mat-icon>
                                    Upload Thumbnail
                                </button>
                                <p>Recommended: 1280x720 pixels, JPG or PNG, max 2MB</p>
                            </div>

                            <div class="thumbnail-preview" *ngIf="thumbnailPreview">
                                <img [src]="thumbnailPreview" alt="Thumbnail preview">
                                <button mat-icon-button (click)="removeThumbnail()" class="remove-thumbnail">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button mat-raised-button color="primary" matStepperNext
                            [disabled]="!basicInfoForm.valid || isTitleChecking">
                            Next: Course Details
                        </button>
                    </div>
                </div>
            </form>
        </mat-step>

        <!-- Step 2: Course Details -->
        <mat-step [stepControl]="detailsForm" label="Course Details">
            <form [formGroup]="detailsForm">
                <div class="step-content">
                    <h2>Course Details</h2>

                    <!-- Requirements Section -->
                    <div class="section">
                        <h3>Course Requirements</h3>
                        <div formArrayName="requirements">
                            <div *ngFor="let requirement of requirements.controls; let i = index" [formGroupName]="i"
                                class="array-item">
                                <mat-form-field appearance="outline" class="array-input">
                                    <mat-label>Requirement {{i + 1}}</mat-label>
                                    <input matInput formControlName="requirement"
                                        placeholder="What students need to know">
                                </mat-form-field>
                                <button mat-icon-button (click)="removeRequirement(i)"
                                    [disabled]="requirements.length === 1" type="button">
                                    <mat-icon>remove_circle</mat-icon>
                                </button>
                            </div>
                        </div>
                        <button mat-button (click)="addRequirement()" type="button">
                            <mat-icon>add</mat-icon>
                            Add Requirement
                        </button>
                    </div>

                    <!-- Learning Outcomes Section -->
                    <div class="section">
                        <h3>Learning Outcomes</h3>
                        <div formArrayName="learningOutcomes">
                            <div *ngFor="let outcome of learningOutcomes.controls; let i = index" [formGroupName]="i"
                                class="array-item">
                                <mat-form-field appearance="outline" class="array-input">
                                    <mat-label>Learning Outcome {{i + 1}}</mat-label>
                                    <input matInput formControlName="outcome" placeholder="What students will learn">
                                </mat-form-field>
                                <button mat-icon-button (click)="removeLearningOutcome(i)"
                                    [disabled]="learningOutcomes.length === 1" type="button">
                                    <mat-icon>remove_circle</mat-icon>
                                </button>
                            </div>
                        </div>
                        <button mat-button (click)="addLearningOutcome()" type="button">
                            <mat-icon>add</mat-icon>
                            Add Learning Outcome
                        </button>
                    </div>

                    <!-- Tags Section -->
                    <div class="section">
                        <h3>Tags</h3>
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Course Tags</mat-label>
                            <input matInput formControlName="tags"
                                placeholder="HTML, CSS, JavaScript, React (comma-separated)">
                            <mat-hint>Add relevant tags separated by commas</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="step-actions">
                        <button mat-button matStepperPrevious>Previous</button>
                        <button mat-raised-button color="primary" matStepperNext [disabled]="!detailsForm.valid">
                            Next: Add Lessons
                        </button>
                    </div>
                </div>
            </form>
        </mat-step>

        <!-- Step 3: Lessons -->
        <mat-step [stepControl]="lessonsForm" label="Lessons">
            <form [formGroup]="lessonsForm">
                <div class="step-content">
                    <h2>Course Lessons</h2>

                    <div formArrayName="lessons">
                        <div *ngFor="let lesson of lessons.controls; let i = index" [formGroupName]="i"
                            class="lesson-card">
                            <div class="lesson-header">
                                <h4>Lesson {{i + 1}}</h4>
                                <button mat-icon-button (click)="removeLesson(i)" [disabled]="lessons.length === 1"
                                    type="button">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>

                            <div class="lesson-content">
                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Lesson Title</mat-label>
                                        <input matInput formControlName="title" placeholder="Enter lesson title">
                                    </mat-form-field>
                                </div>

                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Lesson Description</mat-label>
                                        <textarea matInput formControlName="description" rows="3"
                                            placeholder="Describe what this lesson covers"></textarea>
                                    </mat-form-field>
                                </div>

                                <div class="form-row two-columns">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Video URL (YouTube)</mat-label>
                                        <input matInput formControlName="videoUrl"
                                            placeholder="https://www.youtube.com/watch?v=...">
                                        <mat-hint>Paste YouTube video URL</mat-hint>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Duration (minutes)</mat-label>
                                        <input matInput type="number" formControlName="duration" min="1">
                                    </mat-form-field>
                                </div>

                                <div class="form-row">
                                    <label>Lesson PDF (optional):</label>
                                    <input type="file" accept="application/pdf" (change)="onPdfSelected($event, i)">
                                    <span *ngIf="lesson.get('pdf')?.value">
                                        {{ lesson.get('pdf')?.value.name || lesson.get('pdf')?.value }}
                                        <button mat-icon-button color="warn" (click)="removePdf(i)" type="button">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </span>
                                </div>

                                <div class="form-row">
                                    <mat-checkbox formControlName="isPreview">
                                        Make this lesson available as preview
                                    </mat-checkbox>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button mat-button (click)="addLesson()" type="button" class="add-lesson-btn">
                        <mat-icon>add</mat-icon>
                        Add Another Lesson
                    </button>

                    <div class="step-actions">
                        <button mat-button matStepperPrevious>Previous</button>
                        <button mat-raised-button color="primary" (click)="onSubmit()"
                            [disabled]="!lessonsForm.valid || isUploading">
                            <mat-icon *ngIf="isUploading">hourglass_empty</mat-icon>
                            {{isUploading ? 'Creating Course...' : 'Create Course'}}
                        </button>
                    </div>
                </div>
            </form>
        </mat-step>
    </mat-stepper>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isUploading">
        <mat-card>
            <mat-card-content>
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                <p>Creating your course...</p>
            </mat-card-content>
        </mat-card>
    </div>
</div>